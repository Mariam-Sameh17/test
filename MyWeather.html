<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Past 10-Day Weather</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary: #2c3e50;
        --secondary: #3498db;
        --danger: #e74c3c;
        --warning: #f39c12;
        --success: #2ecc71;
        --light: #ecf0f1;
        --dark: #34495e;
        --bronze-light: #d4af37;
        --bronze-highlight: #f4d03f;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(
          135deg,
          var(--primary),
          var(--dark),
          var(--secondary)
        );
        color: var(--light);
        min-height: 100vh;
        padding: 20px;
        font-size: 18px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        position: relative; /* For positioning context */
      }

      .home-button {
        position: absolute;
        top: 0;
        right: 0;
        background: linear-gradient(
          135deg,
          var(--bronze-light),
          var(--bronze-highlight)
        );
        color: var(--primary);
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
      }

      .home-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .home-button i {
        margin-right: 8px;
      }

      h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        background: linear-gradient(
          to right,
          var(--bronze-light),
          var(--bronze-highlight)
        );
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        text-shadow: 0 0 10px rgba(244, 208, 63, 0.3);
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 10px;
      }

      #location-display {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--bronze-light);
      }

      .loading,
      .error {
        text-align: center;
        padding: 50px;
        display: none; /* Initially hidden */
      }

      #loader.active,
      #error-message.active {
        display: block;
      }

      .spinner {
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 5px solid white;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #weather-grid {
        display: none; /* Hidden until data is loaded */
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
      }

      #weather-grid.active {
        display: grid;
      }

      .weather-card {
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border-top: 3px solid var(--bronze-light);
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        z-index: 1;
      }

      .weather-card:hover {
        transform: scale(1.05);
        z-index: 100;
      }

      .weather-card h3 {
        font-size: 1.2rem;
        margin-bottom: 15px;
      }

      .weather-icon {
        font-size: 3.5rem;
        margin-bottom: 15px;
        filter: drop-shadow(0 0 8px rgba(244, 208, 63, 0.4));
      }

      .weather-icon .fa-sun {
        color: var(--warning);
      }
      .weather-icon .fa-cloud-sun {
        color: #f39c12;
      }
      .weather-icon .fa-cloud {
        color: #bdc3c7;
      }
      .weather-icon .fa-cloud-showers-heavy {
        color: var(--secondary);
      }
      .weather-icon .fa-wind {
        color: #95a5a6;
      }
      .weather-icon .fa-snowflake {
        color: var(--light-blue);
      }

      .temp-details p {
        margin-bottom: 8px;
        font-size: 1rem;
      }

      .temp-details .label {
        font-weight: 600;
      }

      .graph-container {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out;
        margin-top: 15px;
      }

      .weather-card.graph-visible .graph-container {
        max-height: 250px;
      }

      /* Tooltip Styles */
      .weather-tooltip {
        position: absolute;
        top: 50%;
        left: 105%;
        transform: translateY(-50%);
        width: 280px;
        background-color: rgba(44, 62, 80, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 15px;
        z-index: 10;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.2);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }

      .weather-card:hover .weather-tooltip {
        opacity: 1;
        visibility: visible;
      }

      .condition-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
      }

      .condition-name {
        font-weight: 600;
        font-size: 0.9rem;
        width: 100px;
        text-align: left;
      }

      .probability-bar {
        height: 15px;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        flex: 1;
        margin: 0 10px;
        overflow: hidden;
      }

      .probability-fill {
        height: 100%;
        border-radius: 10px;
        transition: width 0.5s ease-in-out;
      }

      .probability-text {
        width: 50px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .hot {
        background-color: var(--danger);
      }
      .cold {
        background-color: var(--secondary);
      }
      .windy {
        background-color: var(--warning);
      }
      .wet {
        background-color: var(--success);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Past 10-Day Weather</h1>
        <p class="subtitle">
          Historical weather data for the last 10 days at your location.
        </p>
        <div id="location-display">Fetching location...</div>
        <a href="HomePage.html" class="home-button"
          ><i class="fas fa-home"></i> Home</a
        >
      </header>

      <main>
        <div class="loading active" id="loader">
          <div class="spinner"></div>
          <p>Retrieving historical weather data...</p>
        </div>

        <div class="error" id="error-message">
          <h2>Could not fetch weather data.</h2>
          <p>Please ensure location services are enabled and try again.</p>
        </div>

        <div id="weather-grid">
          <!-- Weather cards will be injected here by JavaScript -->
        </div>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loader = document.getElementById("loader");
        const errorMessage = document.getElementById("error-message");
        const weatherGrid = document.getElementById("weather-grid");
        const locationDisplay = document.getElementById("location-display");

        async function init() {
          try {
            const position = await getUserLocation();
            const { latitude, longitude } = position.coords;

            const locationName = await getLocationName(latitude, longitude);
            locationDisplay.textContent = locationName;

            const weatherData = await getWeatherData(latitude, longitude);
            displayWeatherData(weatherData);
          } catch (error) {
            let userMessage =
              "Could not get your location. Showing weather for a default location.";
            console.error("Initialization failed:", error.message || error);

            if (error.message && error.message.includes("permissions policy")) {
              userMessage =
                "Geolocation is disabled by your browser settings. Showing weather for a default location.";
            } else if (error && typeof error === "object" && "code" in error) {
              switch (error.code) {
                case 1:
                  userMessage =
                    "You've denied location access. Showing weather for a default location.";
                  break;
                case 2:
                  userMessage =
                    "Your location is currently unavailable. Showing weather for a default location.";
                  break;
                case 3:
                  userMessage =
                    "The request for your location timed out. Showing weather for a default location.";
                  break;
              }
            }

            showError(userMessage);

            locationDisplay.textContent = "Cairo, Egypt (Default)";
            try {
              const weatherData = await getWeatherData(30.0444, 31.2357);
              displayWeatherData(weatherData);
            } catch (fallbackError) {
              console.error("Fallback failed:", fallbackError);
              showError(
                "Could not fetch data for the default location. Please try again later."
              );
            }
          }
        }

        function getUserLocation() {
          return new Promise((resolve, reject) => {
            try {
              if (!navigator.geolocation) {
                reject(
                  new Error("Geolocation is not supported by your browser.")
                );
                return;
              }
              navigator.geolocation.getCurrentPosition(resolve, reject);
            } catch (e) {
              reject(e);
            }
          });
        }

        async function getLocationName(lat, lon) {
          try {
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
            );
            const data = await response.json();
            return (
              `${data?.address?.state},${data?.address?.country}` ||
              data?.address?.suburb ||
              data?.address?.state ||
              data?.address?.country ||
              "Current Location"
            );
          } catch (error) {
            console.error("Error fetching location name:", error);
            return "Current Location";
          }
        }

        async function getWeatherData(lat, lng) {
          const today = new Date();
          const startDate = new Date();
          startDate.setDate(today.getDate() - 9);

          const formatDate = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}${m}${d}`;
          };

          const start = formatDate(startDate);
          const end = formatDate(today);

          const params = ["T2M_MAX", "T2M_MIN", "WS10M", "PRECTOTCORR"].join(
            ","
          );
          const apiUrl = `https://power.larc.nasa.gov/api/temporal/daily/point?parameters=${params}&community=RE&longitude=${lng}&latitude=${lat}&start=${start}&end=${end}&format=JSON`;

          const response = await fetch(apiUrl);
          if (!response.ok) {
            throw new Error("Failed to fetch data from NASA POWER API.");
          }
          const data = await response.json();

          if (!data.properties?.parameter) {
            throw new Error("Invalid data format received from the API.");
          }

          return data.properties.parameter;
        }

        function displayWeatherData(data) {
          loader.classList.remove("active");
          errorMessage.classList.remove("active");
          weatherGrid.innerHTML = "";

          const dates = Object.keys(data.T2M_MAX || {});
          if (dates.length === 0) {
            showError("No historical data available for this location.");
            return;
          }

          dates.sort((a, b) => b.localeCompare(a));

          dates.forEach((dateStr) => {
            const year = dateStr.substring(0, 4);
            const month = dateStr.substring(4, 6);
            const day = dateStr.substring(6, 8);

            const date = new Date(year, month - 1, day);
            const dayName = date.toLocaleDateString("en-US", {
              weekday: "long",
            });

            const maxTemp = data.T2M_MAX[dateStr]?.toFixed(1) || "N/A";
            const minTemp = data.T2M_MIN[dateStr]?.toFixed(1) || "N/A";
            const wind = data.WS10M[dateStr]?.toFixed(1) || "N/A";
            const rain = data.PRECTOTCORR[dateStr]?.toFixed(1) || "N/A";

            const card = document.createElement("div");
            card.className = "weather-card";

            const canvasId = `chart-${dateStr}`;
            const chartData = {
              maxTemp: parseFloat(maxTemp) || 0,
              minTemp: parseFloat(minTemp) || 0,
              wind: parseFloat(wind) || 0,
              rain: parseFloat(rain) || 0,
            };

            const iconClass = getWeatherIcon(maxTemp, wind, rain);

            // --- NEW: Percentage calculation logic ---
            // Normalize values to a 0-100 scale based on thresholds
            const hotPercent = Math.min(
              100,
              Math.max(0, ((maxTemp - 25) / 15) * 100)
            ); // scales from 25C to 40C
            const coldPercent = Math.min(
              100,
              Math.max(0, ((10 - minTemp) / 15) * 100)
            ); // scales from 10C down to -5C
            const windyPercent = Math.min(100, Math.max(0, (wind / 12) * 100)); // scales up to 12 m/s
            const rainyPercent = Math.min(100, Math.max(0, (rain / 10) * 100)); // scales up to 10 mm

            const tooltipHtml = `
                                <div class="weather-tooltip">
                                    <div class="condition-item">
                                        <div class="condition-name">Hot</div>
                                        <div class="probability-bar"><div class="probability-fill hot" style="width: ${hotPercent}%"></div></div>
                                        <div class="probability-text">${hotPercent.toFixed(
                                          0
                                        )}%</div>
                                    </div>
                                    <div class="condition-item">
                                        <div class="condition-name">Cold</div>
                                        <div class="probability-bar"><div class="probability-fill cold" style="width: ${coldPercent}%"></div></div>
                                        <div class="probability-text">${coldPercent.toFixed(
                                          0
                                        )}%</div>
                                    </div>
                                    <div class="condition-item">
                                        <div class="condition-name">Windy</div>
                                        <div class="probability-bar"><div class="probability-fill windy" style="width: ${windyPercent}%"></div></div>
                                        <div class="probability-text">${windyPercent.toFixed(
                                          0
                                        )}%</div>
                                    </div>
                                     <div class="condition-item">
                                        <div class="condition-name">Rainy</div>
                                        <div class="probability-bar"><div class="probability-fill wet" style="width: ${rainyPercent}%"></div></div>
                                        <div class="probability-text">${rainyPercent.toFixed(
                                          0
                                        )}%</div>
                                    </div>
                                </div>
                            `;

            card.innerHTML = `
                                <h3>${dayName}</h3>
                                <div class="weather-icon"><i class="fas ${iconClass}"></i></div>
                                <div class="temp-details">
                                    <p><span class="label">Max:</span> ${maxTemp}째C</p>
                                    <p><span class="label">Min:</span> ${minTemp}째C</p>
                                    <p><span class="label">Wind:</span> ${wind} m/s</p>
                                    <p><span class="label">Rain:</span> ${rain} mm</p>
                                </div>
                                <div class="graph-container">
                                   <canvas id="${canvasId}"></canvas>
                                </div>
                                ${tooltipHtml}
                            `;

            card.addEventListener("click", () => {
              const isVisible = card.classList.toggle("graph-visible");
              const chartExists = Chart.getChart(canvasId);

              if (isVisible && !chartExists) {
                createWeatherChart(canvasId, chartData);
              }
            });

            weatherGrid.appendChild(card);
          });

          weatherGrid.classList.add("active");
        }

        function createWeatherChart(canvasId, data) {
          const ctx = document.getElementById(canvasId).getContext("2d");
          new Chart(ctx, {
            type: "bar",
            data: {
              labels: [
                "Max Temp (째C)",
                "Min Temp (째C)",
                "Wind (m/s)",
                "Rain (mm)",
              ],
              datasets: [
                {
                  label: "Weather Metrics",
                  data: [data.maxTemp, data.minTemp, data.wind, data.rain],
                  backgroundColor: [
                    "rgba(231, 76, 60, 0.5)",
                    "rgba(52, 152, 219, 0.5)",
                    "rgba(149, 165, 166, 0.5)",
                    "rgba(46, 204, 113, 0.5)",
                  ],
                  borderColor: [
                    "rgb(231, 76, 60)",
                    "rgb(52, 152, 219)",
                    "rgb(149, 165, 166)",
                    "rgb(46, 204, 113)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false,
                },
                title: {
                  display: true,
                  text: "Daily Weather Summary",
                  color: "white",
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: "white" },
                  grid: { color: "rgba(255, 255, 255, 0.2)" },
                },
                x: {
                  ticks: { color: "white" },
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                },
              },
            },
          });
        }

        function getWeatherIcon(temp, wind, rain) {
          if (rain > 2.0) return "fa-cloud-showers-heavy";
          if (wind > 8.0) return "fa-wind";
          if (temp > 30) return "fa-sun";
          if (temp < 10) return "fa-snowflake";
          return "fa-cloud-sun";
        }

        function showError(message = "An error occurred.") {
          loader.classList.remove("active");
          weatherGrid.classList.remove("active");
          errorMessage.querySelector("p").textContent = message;
          errorMessage.classList.add("active");
        }

        init();
      });
    </script>
  </body>
</html>
